!function(){"use strict";let e={key:null,token:null,expires:0};const t=window.fetch;async function n(e,t){const n=function(e){const t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.charCodeAt(e);return o.buffer}(e),o=await window.crypto.subtle.importKey("raw",n,{name:"AES-GCM"},!1,["encrypt"]),r=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,t),i=new Uint8Array(r.length+a.byteLength);return i.set(r,0),i.set(new Uint8Array(a),r.length),function(e){let t="";const n=new Uint8Array(e),o=n.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(n[e]);return window.btoa(t)}(i.buffer)}async function o(){const n=Date.now();if(e.key&&e.token&&n<e.expires)return e;const o=await t("/goga/api/v1/key");if(!o.ok)throw e={key:null,token:null,expires:0},new Error("无法获取加密密钥。");const{key:r,token:a,ttl:i}=await o.json(),s=1e3*i*.8||24e4;return e={key:r,token:a,expires:Date.now()+s},e}window.fetch=async function(...e){const[r,a]=e;if(a&&a.method&&"POST"===a.method.toUpperCase()&&a.body&&"string"==typeof a.body&&!r.toString().includes("/goga/api/v1/key"))try{JSON.parse(a.body);const e=a.headers&&a.headers["Content-Type"]||"application/json",i=a.body,s=new TextEncoder,c=s.encode(e),y=s.encode(i);if(c.length>255)throw new Error("Content-Type header is too long (max 255 bytes).");const w=new Uint8Array(1+c.length+y.length);w[0]=c.length,w.set(c,1),w.set(y,1+c.length);const{key:d,token:l}=await o(),u={token:l,encrypted:await n(d,w.buffer)},h={...a};return h.body=JSON.stringify(u),h.headers={...h.headers,"Content-Type":"application/json"},t(r,h)}catch(n){return t(...e)}return t(...e)},document.addEventListener("DOMContentLoaded",()=>{o().catch(e=>{})})}();