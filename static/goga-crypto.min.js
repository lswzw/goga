!function(){"use strict";const t=window.gogaCryptoConfig&&window.gogaCryptoConfig.excludeUrls||[];function e(e){for(const n of t){if("string"==typeof n&&e.includes(n))return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}if(!window.crypto||!window.crypto.subtle)return;let n={key:null,token:null,expires:0};const o=window.fetch,r=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send,a=XMLHttpRequest.prototype.setRequestHeader;async function s(t,e){const n=function(t){const e=window.atob(t),n=e.length,o=new Uint8Array(n);for(let t=0;t<n;t++)o[t]=e.charCodeAt(t);return o.buffer}(t),o=await window.crypto.subtle.importKey("raw",n,{name:"AES-GCM"},!1,["encrypt"]),r=window.crypto.getRandomValues(new Uint8Array(12)),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,e),a=new Uint8Array(r.length+i.byteLength);return a.set(r,0),a.set(new Uint8Array(i),r.length),function(t){let e="";const n=new Uint8Array(t),o=n.byteLength;for(let t=0;t<o;t++)e+=String.fromCharCode(n[t]);return window.btoa(e)}(a.buffer)}async function p(){const t=Date.now();if(n.key&&n.token&&t<n.expires)return n;const e=await o("/goga/api/v1/key");if(!e.ok)throw n={key:null,token:null,expires:0},new Error("goganokey");const{key:r,token:i,ttl:a}=await e.json(),s=1e3*a*.8||24e4;return n={key:r,token:i,expires:Date.now()+s},n}async function c(t,e){const n=new TextEncoder,o=n.encode(e),r=n.encode(t);if(o.length>255)throw new Error("Content-Type header is too long (max 255 bytes).");const i=new Uint8Array(1+o.length+r.length);i[0]=o.length,i.set(o,1),i.set(r,1+o.length);const{key:a,token:c}=await p();return{token:c,encrypted:await s(a,i.buffer)}}window.fetch=async function(...t){const[n,r]=t;if(r&&r.method&&"POST"===r.method.toUpperCase()&&r.body&&"string"==typeof r.body&&!n.toString().includes("/goga/api/v1/key")){if(e(n.toString()))return o(...t);try{const e=r.headers&&(r.headers["Content-Type"]||r.headers["content-type"])||"application/json";if(!e.includes("application/json"))return o(...t);JSON.parse(r.body);const i=await c(r.body,e),a={...r};return a.body=JSON.stringify(i),a.headers={...a.headers,"Content-Type":"application/json;charset=UTF-8"},o(n,a)}catch(e){return o(...t)}}return o(...t)},XMLHttpRequest.prototype.open=function(t,e,...n){return this._goga_method=t,this._goga_url=e,this._goga_headers={},r.apply(this,[t,e,...n])},XMLHttpRequest.prototype.setRequestHeader=function(t,e){return this._goga_headers[t.toLowerCase()]=e,a.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){const n=this,o=n._goga_url;if(!(n._goga_method&&"POST"===n._goga_method.toUpperCase()&&t&&"string"==typeof t&&!o.toString().includes("/goga/api/v1/key")))return i.apply(n,arguments);e(o.toString())?i.apply(n,arguments):async function(){try{const e=n._goga_headers["content-type"]||"application/json";if(!e.includes("application/json"))return void i.apply(n,arguments);JSON.parse(t);const o=await c(t,e),r=JSON.stringify(o);i.call(n,r)}catch(t){i.apply(n,arguments)}}()},document.addEventListener("DOMContentLoaded",()=>{p().catch(t=>{})})}();