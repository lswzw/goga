!function(){"use strict";if(!window.crypto||!window.crypto.subtle)return;let t={key:null,token:null,expires:0};const e=window.fetch,n=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send,r=XMLHttpRequest.prototype.setRequestHeader;async function a(t,e){const n=function(t){const e=window.atob(t),n=e.length,o=new Uint8Array(n);for(let t=0;t<n;t++)o[t]=e.charCodeAt(t);return o.buffer}(t),o=await window.crypto.subtle.importKey("raw",n,{name:"AES-GCM"},!1,["encrypt"]),r=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,e),i=new Uint8Array(r.length+a.byteLength);return i.set(r,0),i.set(new Uint8Array(a),r.length),function(t){let e="";const n=new Uint8Array(t),o=n.byteLength;for(let t=0;t<o;t++)e+=String.fromCharCode(n[t]);return window.btoa(e)}(i.buffer)}async function i(){const n=Date.now();if(t.key&&t.token&&n<t.expires)return t;const o=await e("/goga/api/v1/key");if(!o.ok)throw t={key:null,token:null,expires:0},new Error("无法获取加密密钥。");const{key:r,token:a,ttl:i}=await o.json(),s=1e3*i*.8||24e4;return t={key:r,token:a,expires:Date.now()+s},t}async function s(t,e){const n=new TextEncoder,o=n.encode(e),r=n.encode(t);if(o.length>255)throw new Error("Content-Type header is too long (max 255 bytes).");const s=new Uint8Array(1+o.length+r.length);s[0]=o.length,s.set(o,1),s.set(r,1+o.length);const{key:p,token:c}=await i();return{token:c,encrypted:await a(p,s.buffer)}}window.fetch=async function(...t){const[n,o]=t;if(o&&o.method&&"POST"===o.method.toUpperCase()&&o.body&&"string"==typeof o.body&&!n.toString().includes("/goga/api/v1/key"))try{const r=o.headers&&(o.headers["Content-Type"]||o.headers["content-type"])||"application/json";if(!r.includes("application/json"))return e(...t);JSON.parse(o.body);const a=await s(o.body,r),i={...o};return i.body=JSON.stringify(a),i.headers={...i.headers,"Content-Type":"application/json;charset=UTF-8"},e(n,i)}catch(n){return e(...t)}return e(...t)},XMLHttpRequest.prototype.open=function(t,e,...o){return this._goga_method=t,this._goga_url=e,this._goga_headers={},n.apply(this,[t,e,...o])},XMLHttpRequest.prototype.setRequestHeader=function(t,e){return this._goga_headers[t.toLowerCase()]=e,r.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){const e=this,n=e._goga_url;if(!(e._goga_method&&"POST"===e._goga_method.toUpperCase()&&t&&"string"==typeof t&&!n.toString().includes("/goga/api/v1/key")))return o.apply(e,arguments);!async function(){try{const n=e._goga_headers["content-type"]||"application/json";if(!n.includes("application/json"))return void o.apply(e,arguments);JSON.parse(t);const r=await s(t,n),a=JSON.stringify(r);o.call(e,a)}catch(t){o.apply(e,arguments)}}()},document.addEventListener("DOMContentLoaded",()=>{i().catch(t=>{})})}();