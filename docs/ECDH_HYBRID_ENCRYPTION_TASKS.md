# GoGa ECDH 混合加密与非入侵式双向通信实施任务文档 (v4.0)

## 1. 实施概述

本文档详细描述了 GoGa 系统中实现 **非入侵式** ECDH 混合加密双向通信的实施任务。该方案旨在为现有系统提供透明的加密层，无需改动原有的前后端业务逻辑。

### 1.1 设计核心原则

1.  **非入侵式设计 (Non-Intrusive)**
    - **前端**: `goga.js` 库通过自动拦截 `fetch` 和 `XMLHttpRequest`，实现对 HTTP 请求和响应的透明加密与解密。业务代码无需修改，开发者无感知。
    - **后端**: GoGa 网关作为反向代理，在中间件（Middleware）层完成请求解密和响应加密。上游（Upstream）的业务服务接收的是解密后的明文请求，其响应也会被网关自动加密，对业务服务完全透明。

2.  **安全与标准化的加密架构**
    - **密钥交换**: 采用 ECDH（P-256 曲线）协商共享密钥，实现前向保密性。
    - **密钥派生**: 使用 HKDF (RFC5869) 从共享密钥派生出用于请求和响应的独立对称加密密钥。
    - **数据加密**: 使用 AES-256-GCM 算法。IV (Nonce) 是一个不需保密的随机数，将以**明文**形式与密文一同传输，其完整性由 AES-GCM 的认证标签（Authentication Tag）保护。**绝不使用非标准方式对IV进行加密**。

### 1.2 实施时间线

- **总预计时间**: 12周
- **阶段一 (基础密码库与密钥交换)**: 第1-3周
- **阶段二 (端到端集成与会话管理)**: 第4-7周
- **阶段三 (安全增强与性能优化)**: 第8-10周
- **阶段四 (生产就绪与部署)**: 第11-12周

### 1.3 当前进度状态 (已重置)

**已完成的基础库任务**:
- ✅ 2.1.1 前端ECDH基础库 (`crypto-utils`, `ecdh-lib`)
  - ECDH密钥对生成、公钥导入/导出、共享密钥计算函数库。
- ✅ 2.1.2 后端ECDH基础库 (`internal/crypto/ecdh.go`)
  - Go语言实现的ECDH核心功能库。
- ✅ 2.2.1 前端AES-GCM基础库 (`aes-lib`)
  - 基础的AES-GCM加密/解密函数。
- ✅ 2.2.2 后端AES-GCM基础库 (`internal/crypto/crypto.go`)
  - Go语言实现的AES-GCM加解密核心函数。

**待办亮点**:
- 建立完整的前后端密钥交换流程。
- 实现非入侵式的前端拦截器和后端中间件。
- 完成端到端的加密通信集成测试。

---

## 2. 阶段一：基础密码库与密钥交换 (第1-3周)

### 2.1 任务1.1: ECDH 密钥交换实现 (第1-2周)

#### 2.1.1 前端实现 ✅

**子任务**:
- [x] 实现ECDH密钥对生成函数
- [x] 实现公钥导入/导出功能 (Base64)
- [x] 实现共享密钥计算函数
- [x] 实现HKDF密钥派生功能
- [ ] **(未开始)** 创建 `/goga/api/v1/key-exchange` 的客户端调用逻辑
- [ ] **(未开始)** 建立会话和密钥的本地缓存机制 (Session/LocalStorage)

**验收标准**:
- [x] 基础密码学函数（生成、导入/导出、计算）功能正确。
- [ ] 能够与后端定义的API端点成功交换密钥。

#### 2.1.2 后端实现

**子任务**:
- [x] 实现ECDH密钥对生成、导入/导出和共享密钥计算的核心库 (`internal/crypto/ecdh.go`)
- [x] 实现HKDF密钥派生功能 (`internal/crypto/hkdf.go`)
- [ ] **(未开始)** 实现 `/goga/api/v1/key-exchange` API 端点 (`internal/gateway/keyexchange.go`)
- [ ] **(未开始)** 实现服务端会话管理和缓存机制（如 Redis）

**验收标准**:
- [x] 基础密码学函数库功能正确。
- [ ] API端点能够正确处理客户端公钥，返回服务端公钥和会话信息。
- [ ] 密钥派生结果与前端一致。

### 2.2 任务1.2: AES-GCM 加密/解密实现 (第2-3周)

#### 2.2.1 前端实现

**子任务**:
- [x] 实现底层的AES-GCM加密/解密函数
- [ ] **(未开始)** 实现加密消息构造函数：根据标准架构，生成包含`iv`和`encryptedData`的JSON对象。
- [ ] **(未开始)** 实现IV生成逻辑 (使用`crypto.getRandomValues`)。

**验收标准**:
- [x] 基础加解密函数可用。
- [ ] 构造的加密消息格式符合[接口设计](#82-接口设计)。

#### 2.2.2 后端实现

**子任务**:
- [x] 实现底层的AES-GCM加密/解密函数 (`internal/crypto/crypto.go`)
- [ ] **(未开始)** 实现消息解析逻辑：从请求中解析出`iv`和`encryptedData`。
- [ ] **(未开始)** 实现响应加密逻辑：构造包含`iv`和`encryptedData`的加密响应。

**验收标准**:
- [x] 基础加解密函数可用。
- [ ] 能够正确解析前端发送的加密消息格式。
- [ ] 能够正确构造加密响应。

### 2.3 任务1.3: 模块化与构建脚本 (第3周)

**子任务**:
- [ ] 创建`goga.js`的模块化文件结构 (如 `src/ecdh.js`, `src/aes.js`, `src/interceptor.js`)
- [ ] 创建基础构建脚本，用于将各模块合并为单一的 `static/goga.js`。

**验收标准**:
- [ ] 构建流程可以自动化执行。
- [ ] 合并后的文件可以被浏览器正常加载。

---

## 3. 阶段二：端到端集成与会话管理 (第4-7周)

此阶段是实现**非入侵原则**的核心。

### 3.1 任务2.1: 非入侵式通信集成 (第4-6周)

#### 3.1.1 前端集成

**子任务**:
- [ ] 实现 `fetch` 和 `XMLHttpRequest` 的请求拦截器。
- [ ] 在拦截器中集成加密流程：自动完成密钥协商、请求加密。
- [ ] 在拦截器中集成解密流程：自动解密服务器的加密响应。
- [ ] 实现URL排除逻辑，对某些路径（如`/key-exchange`本身）不进行加密。
- [ ] 实现优雅的错误处理和降级机制。

**验收标准**:
- [ ] 现有web应用引入`goga.js`后，所有API请求被自动加密。
- [ ] 加密响应被自动解密，应用逻辑能收到明文数据。
- [ ] 整个过程对应用代码透明。

#### 3.1.2 后端集成

**子任务**:
- [ ] 实现请求解密的Go中间件 (`internal/middleware/decryption.go`)。
- [ ] 将解密中间件应用于GoGa网关的路由。
- [ ] 实现响应加密的Go中间件，捕获上游服务的响应并加密。
- [ ] 实现完善的错误处理和日志记录。

**验收标准**:
- [ ] 中间件能正确解密前端请求，并将明文请求代理到上游服务。
- [ ] 中G
a网关能正确加密上游服务的响应。
- [ ] 上游业务服务无需任何修改。

### 3.2 任务2.2: 会话管理集成 (第6-7周)

**子任务**:
- [ ] **前端**: 实现会话自动续期和过期后的重新协商。
- [ ] **后端**: 实现会话存储（Redis/内存）、过期清理和状态查询。
- [ ] 设计并实现端到端的会话管理测试用例（并发、过期、清理）。

**验收标准**:
- [ ] 会话能够成功建立、维护、并在过期前自动续期。
- [ ] 大量并发会话下系统保持稳定，无内存泄漏。

### 3.3 任务2.3: 集成测试 (第7周)

**子任务**:
- [ ] 设计并实现端到端的自动化测试套件。
- [ ] 验证完整的生命周期：密钥交换 -> 加密请求 -> 后端解密 -> 上游处理 -> 后端加密 -> 前端解密。
- [ ] 在多种浏览器（Chrome, Firefox, Safari）上进行兼容性测试。

**验收标准**:
- [ ] 所有端到端测试用例通过。
- [ ] 浏览器兼容性符合要求。

---

## 4. 阶段三：安全增强与性能优化 (第8-10周)

### 4.1 任务3.1: 抗攻击机制 (第8-9周)

**子任务**:
- [ ] **后端**: 实现基于时间戳和缓存的重放攻击防护机制。
- [ ] **后端**: 对密钥交换等关键API实现速率限制（Rate Limiting）。
- [ ] **安全审计**: 由安全工程师审查加密流程和实现，确保无逻辑漏洞。

**验收标准**:
- [ ] 重放攻击能够被有效识别和阻止。
- [ ] 速率限制按预期工作。
- [ ] 通过内部安全审计。

### 4.2 任务3.2: 性能优化 (第9-10周)

**子任务**:
- [ ] **后端**: 针对高频密码学操作，研究并引入对象池/缓冲池（如`sync.Pool`）以减少GC压力。
- [ ] **前端/后端**: 进行性能基准测试，识别并优化瓶颈。
- [ ] **前端**: 优化`goga.js`，减少不必要的计算和内存占用。

**验收标准**:
- [ ] 加密通信带来的性能开销在可接受范围内（例如，延迟增加 < 50ms）。
- [ ] 资源使用（CPU, 内存）稳定，无泄漏。

### 4.3 任务3.3: 安全与性能测试 (第10周)

**子任务**:
- [ ] 执行渗透测试，重点关注密钥交换和加密消息处理。
- [ ] 执行压力测试，评估高并发下的系统性能和稳定性。

**验收标准**:
- [ ] 无高风险安全漏洞。
- [ ] 性能指标在高并发下满足要求。

---

## 5. 阶段四：生产就绪与部署 (第11-12周)

### 5.1 任务4.1: 生产构建与混淆 (第11周)

**子任务**:
- [ ] 配置生产构建流程，包括代码压缩和优化。
- [ ] **评估并实施**代码混淆策略。从基础混淆开始，逐步引入更高级的选项。
- [ ] **为每种混淆配置创建完整的回归测试**，验证其不会破坏任何功能。
- [ ] 目标是找到安全性和稳定性之间的最佳平衡点，而非最强的混淆。

**验收标准**:
- [ ] 生产版本的`goga.min.js`文件大小最优。
- [ ] 经过混淆的代码在所有目标浏览器中功能完好。

### 5.2 任务4.2: 部署与监控 (第12周)

**子任务**:
- [ ] 准备生产环境部署脚本和配置文件。
- [ ] 配置监控和警报（例如，加密/解密失败率、密钥交换延迟）。
- [ ] 制定详细的回滚计划。
- [ ] 执行上线，并进行密切监控和评估。

**验收标准**:
- [ ] 部署流程自动化且可重复。
- [ ] 监控系统能有效反映加密层健康状况。
- [ ] 系统在生产环境稳定运行。

---

## 6. 风险管理

| 风险 | 概率 | 影响 | 缓解措施 |
|---|---|---|---|
| 混淆导致功能异常 | **高** | 高 | **强制要求对每次混淆变更进行全面回归测试**，分阶段增强混淆级别。 |
| 浏览器兼容性问题 | 中 | 高 | 从阶段二开始就进行跨浏览器测试，准备兼容性问题预案。 |
| 性能不达标 | 中 | 中 | 尽早进行性能基准测试（阶段三），预留优化时间。 |
| 加密实现错误 | 低 | 高 | 严格遵循标准库和流程，代码审查，安全审计。 |

---

## 7. 附录：加密架构与接口设计

### 7.1 加密架构流程

1.  **协商**: 客户端通过 `/key-exchange` 接口与服务器完成ECDH密钥协商，计算出共享密钥 `S`。
2.  **派生**: 客户端和服务器各自使用HKDF从 `S` 派生出两个独立的密钥：`requestKey` 和 `responseKey`。
3.  **加密请求**:
    a. 客户端生成一个随机的、**一次性**的 `iv`。
    b. 使用 `requestKey` 和 `iv` 通过AES-GCM加密请求体数据，得到 `encryptedData`。
    c. 将 `iv` 和 `encryptedData` 组装成JSON载荷发送给服务器。
4.  **解密请求**:
    a. 服务器从载荷中**明文读取** `iv`。
    b. 使用 `requestKey` 和 `iv` 解密 `encryptedData`，得到原始请求体。
    c. 将原始请求体发往上游服务。
5.  **加密响应**:
    a. 服务器（网关）截获上游服务的响应。
    b. 生成一个新的随机 `iv`。
    c. 使用 `responseKey` 和新 `iv` 加密响应体，得到 `encryptedData`。
    d. 组装成JSON载荷返回给客户端。
6.  **解密响应**:
    a. 客户端从载荷中**明文读取** `iv`。
    b. 使用 `responseKey` 和 `iv` 解密 `encryptedData`，得到原始响应体。
    c. 将原始响应体返回给业务逻辑。

### 7.2 接口设计

**密钥交换接口**: `/goga/api/v1/key-exchange` (POST)
- **请求**: `{ "clientPublicKey": "base64-encoded-key" }`
- **响应**: `{ "serverPublicKey": "base64-encoded-key", "sessionId": "session-id", "ttl": 3600 }`

**加密消息格式** (用于请求体和响应体)
```json
{
    "version": "2.0",
    "sessionId": "session-id",
    "iv": "base64编码的明文IV",
    "encryptedData": "base64编码的AES-GCM加密数据"
}
```

---
**版本历史**:
| 版本 | 日期 | 作者 | 更改描述 |
|---|---|---|---|
| ... | ... | ... | ... |
| 4.0 | 2025-11-28 | AI助手 | **重大重构**：修正加密架构，确立非入侵原则，重置任务状态以解决矛盾。 |
