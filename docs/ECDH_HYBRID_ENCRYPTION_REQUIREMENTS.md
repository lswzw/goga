# GoGa ECDH 混合加密双向通信需求文档

## 1. 概述

本文档旨在明确 GoGa 系统 ECDH 混合加密通信方案的功能、非功能及安全需求。该方案结合了 ECDH 非对称加密和 AES-GCM 对称加密，为客户端与服务器之间的双向通信提供强大的安全保障。本文档内容已根据 `ECDH_HYBRID_ENCRYPTION_TASKS.md` 中描述的最终实施架构进行了同步。

### 1.1 目标

- **安全密钥交换**: 使用 ECDH 非对称加密技术，安全地协商一次性的会话密钥。
- **双向数据加密**: 实现客户端请求和服务器响应数据的端到端加密，确保机密性。
- **数据完整性**: 利用 AES-GCM 的认证功能，防止数据在传输过程中被篡改。
- **前向保密**: 确保每个会话使用独立的加密密钥，历史通信的安全不受未来密钥泄露的影响。
- **高性能**: 将高开销的非对称加密限制在握手阶段，保证业务数据传输的高性能。

### 1.2 范围

本需求文档覆盖以下范围：
- Web 客户端 (JavaScript) 与 GoGa 网关之间的 HTTP(S) 通信加密。
- API 请求和响应体的加密与解密。
- 会话的建立、管理和安全轮换。

## 2. 功能需求

### FR1: 安全会话建立

- **FR1.1**: 系统必须提供一个唯一的 API 端点 (`/goga/api/v1/key-exchange`) 用于发起密钥交换。
- **FR1.2**: 客户端必须能生成临时的 ECDH P-256 密钥对，并将其公钥发送到服务器。
- **FR1.3**: 服务器必须能处理客户端的公钥，生成自己的 ECDH 密钥对，并返回其公钥及一个唯一的 `sessionId`。
- **FR1.4**: 客户端和服务器必须能各自计算出相同的共享密钥。
- **FR1.5**: 系统必须使用 HKDF-SHA256 从共享密钥派生出独立的请求密钥 (`requestKey`) 和响应密钥 (`responseKey`)。

### FR2: 请求加密

- **FR2.1**: 客户端在发送业务请求前，必须使用会话的 `requestKey` 对请求体进行 AES-GCM 加密。
- **FR2.2**: 客户端必须为每次加密生成一个随机的、12字节的初始化向量 (IV)。
- **FR2.3**: **(核心需求)** 客户端必须使用 `requestKey` 对 FR2.2 中生成的 IV 再次进行加密。
- **FR2.4**: 加密的请求必须遵循指定的 JSON 格式，包含 `sessionId`, `encryptedData`, `encryptedIV` 和 `ivLength` 字段。
- **FR2.5**: 服务器必须能正确解密请求，首先解密 `encryptedIV` 得到原始 IV，然后用该 IV 解密 `encryptedData`。

### FR3: 响应加密

- **FR3.1**: 服务器在返回业务响应前，必须使用会话的 `responseKey` 对响应体进行 AES-GCM 加密。
- **FR3.2**: 服务器必须为每次加密生成一个随机的 IV，并使用 `responseKey` 对该 IV 再次加密。
- **FR3.3**: 加密的响应必须遵循与请求相同的 JSON 格式。
- **FR3.4**: 客户端必须能正确解密服务器的响应。

### FR4: 会话管理

- **FR4.1**: 服务器必须在内存中维护会话及其关联的密钥，并通过 `sessionId`进行索引。
- **FR4.2**: 会话必须有明确的生存时间 (TTL)，过期后自动由服务器清理。
- **FR4.3**: 当客户端使用过期的 `sessionId` 时，服务器必须返回明确的错误，指引客户端重新建立会话。

## 3. 非功能需求

### NFR1: 安全性

- **NFR1.1**: 所有加密操作必须使用行业标准算法：ECDH P-256、AES-256-GCM、HKDF-SHA256。
- **NFR1.2**: ECDH 私钥必须是临时的，仅在内存中存在，绝不能被持久化或传输。
- **NFR1.3**: 所有加密通信必须在 TLS 1.2 或更高版本的信道上传输。
- **NFR1.4**: 系统应能抵御常见的密码学攻击，如重放攻击（通过会话机制间接防御）和中间人攻击（依赖TLS）。

### NFR2: 性能

- **NFR2.1**: 初始密钥交换（会话建立）的总耗时不应超过 200 毫秒。
- **NFR2.2**: 对称加解密操作引入的平均延迟应低于 20 毫秒。
- **NFR2.3**: 加密模块在服务器端引入的额外内存开销应保持在合理水平。

### NFR3: 兼容性

- **NFR3.1**: 客户端加密库必须兼容所有支持 Web Crypto API 的现代浏览器（如 Chrome, Firefox, Safari, Edge 的最新版本）。
- **NFR3.2**: 加密层对上层业务应用应保持透明。

### NFR4: 可用性

- **NFR4.1**: 在密钥过期或解密失败时，系统应返回标准化的错误代码和信息。
- **NFR4.2**: 系统应提供详细的日志，用于问题排查和安全审计。

## 4. 验收标准

### 4.1 功能验收

- [ ] **密钥交换**: 客户端调用 `/goga/api/v1/key-exchange` 能成功获取 `serverPublicKey` 和 `sessionId`。
- [ ] **请求加密**: 客户端发送的请求体符合 `{ "version": "1.0", "sessionId": "...", "encryptedData": "...", "encryptedIV": "...", "ivLength": 12 }` 格式。
- [ ] **请求解密**: 服务器能使用正确的 `requestKey` 成功解密 `encryptedIV` 和 `encryptedData`，并处理原始业务逻辑。
- [ ] **响应加密**: 服务器返回的响应体符合加密 JSON 格式。
- [ ] **响应解密**: 客户端能使用 `responseKey` 成功解密响应，并获取原始响应内容。
- [ ] **会话过期**: 使用已过期的 `sessionId` 请求时，会收到认证失败或会话无效的错误。

### 4.2 性能验收

- [ ] 密钥交换端点的 P95 响应时间低于 200ms。
- [ ] 启用加密后，业务端点的 P95 延迟增加值低于 20ms。
- [ ] 在高并发（如 1000 QPS）场景下，服务器内存使用稳定，无明显泄漏。

### 4.3 安全验收

- [ ] 截获的流量中，请求和响应体均为密文格式。
- [ ] 无法使用一个会话的密钥解密另一个会话的数据。
- [ ] 在 TLS 保护下，能抵御基本的中间人攻击测试。

---
**版本历史**:

| 版本 | 日期 | 作者 | 更改描述 |
|:---|:---|:---|:---|
| 1.0 | 2025-11-28 | AI | 初始版本，包含一些与最终实现不符的设计。 |
| 2.0 | 2025-11-28 | AI | 根据 `TASKS.md` 中已实施的架构重写文档，重点同步了功能需求和验收标准，以匹配“加密IV”的核心设计。 |
