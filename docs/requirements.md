# GoGa - 基于 Go 的零侵入 Web 表单加密网关

## 1. 项目概述与目标

GoGa 是一个基于 Go 语言实现的反向代理网关。其核心目标是在不侵入现有前端或后端业务系统的前提下，透明地实现对 Web 表单提交数据的应用层加密，从而增强数据在传输链路中的安全性。网关通过拦截 HTTP 请求，在客户端（浏览器）和后端服务器之间建立一个安全的加密和解密通道。

---

## 2. 核心功能需求

### 2.1. 零侵入反向代理
- **需求描述**：网关必须能作为标准的反向代理服务器运行，将客户端请求转发至后端业务应用。整个过程对前端和后端系统完全透明，无需修改任何现有代码。
- **验收标准**：
    - a. 可以通过配置文件指定后端业务服务器的地址（URL）。
    - b. 未开启加密功能时，网关应能正确代理所有类型的 HTTP 请求（GET, POST, PUT, 等）和响应。
    - c. 代理过程中应保留必要的 HTTP 头部信息，如 `X-Forwarded-For`。

### 2.2. 静态资源处理与加密脚本注入
- **需求描述**：网关需要能够代理静态资源（HTML, JS, CSS, 图片等）。当代理的资源是 HTML 页面时，必须自动向页面注入一个用于表单加密的 JavaScript 脚本。
- **验收标准**：
    - a. 网关能够正确识别 `Content-Type` 为 `text/html` 的响应。
    - b. 在响应的 HTML body 结束标签 `</body>` 前，自动插入一个 `<script>` 标签，用于加载加密逻辑的 JS 文件。
    - c. 注入的脚本应使用 `async` 或 `defer` 属性，避免阻塞页面渲染。
    - d. 对于非 HTML 静态资源（如 JS, CSS, JPG, PNG 等），网关直接代理转发，不进行任何修改。

### 2.3. 客户端（浏览器端）加密
- **需求描述**：被注入的 JavaScript 脚本负责在客户端执行加密操作。它会自动挂钩页面上的表单提交事件，在数据发送前进行加密。
- **验收标准**：
    - a. 脚本能自动侦测页面中所有表单的 `submit` 事件。
    - b. 在表单提交前，脚本从一个安全的网关API端点获取临时加密密钥或配置。
    - c. 脚本将指定的表单字段（可配置）或整个表单数据使用 `AES-256-GCM` 算法进行加密。
    - d. 原始的表单数据被替换为一个统一格式的加密负载，例如 `{"encrypted": "BASE64_ENCODED_CIPHERTEXT"}`。
    - e. 加密后的请求被发送到原始的表单 `action` URL。

### 2.4. 网关请求解密
- **需求描述**：网关拦截所有发往后端的请求，并识别出经过客户端加密的请求，对其进行解密，还原成原始的表单数据。
- **验收标准**：
    - a. 网关能够识别特定格式的加密请求（例如，POST 请求体为 `{"encrypted": "..."}` 的 JSON）。
    - b. 使用与客户端匹配的密钥，正确解密 `AES-256-GCM` 加密数据。
    - c. 解密失败的请求应被拒绝，并返回 `400 Bad Request` 错误，不能将无效数据转发到后端。
    - d. 成功解密后，将数据还原为原始的 `application/x-www-form-urlencoded` 或 `application/json` 格式。

### 2.5. 请求转发
- **需求描述**：解密后的明文请求被正确地转发到后端业务服务器。
- **验收标准**：
    - a. 请求以原始的 `Content-Type` 和数据格式发送到后端。
    - b. 后端服务器收到的请求应与未经过网关时收到的请求格式完全一致。

### 2.6. 密钥管理
- **需求描述**：为了保障安全性，加密密钥的管理必须遵循安全最佳实践。
- **验收标准**：
    - a. 主加密密钥（用于派生或验证客户端密钥）绝不能硬编码在代码中。
    - b. 必须支持通过环境变量（例如 `GOGA_ENCRYPTION_KEY`）加载主密钥。
    - c. 网关应提供一个安全的、短生命周期或随机算法的机制（如 API 端点）供客户端脚本获取加密所需的信息，避免主密钥直接暴露到前端。

---

## 3. 非功能性需求

### 3.1. 性能
- **需求描述**：网关处理不应成为业务性能瓶颈。
- **验收标准**：
    - a. **吞吐量**：单个网关实例 QPS (每秒查询率) 应不低于 1000。
    - b. **延迟**：纯粹由网关引入的加密和解密操作总延迟应在 10 毫秒以内。
    - c. **资源占用**：网关应在合理的 CPU 和内存使用率下运行。

### 3.2. 安全性
- **需求描述**：保障网关自身和通过其传输的数据的安全性。
- **验收标准**：
    - a. **传输层加密**：网关与客户端之间的所有通信强制使用 HTTPS（TLS 1.2 及以上版本）。
    - b. **加密算法**：应用层加密必须使用 `AES-256-GCM`，禁止使用如 `ECB` 等不安全的模式。
    - c. **网关自身安全**：网关应能抵御常见的 Web 攻击，如跨站脚本（XSS）、跨站请求伪造（CSRF）和服务器端请求伪造（SSRF）。

### 3.3. 兼容性
- **需求描述**：网关应与主流浏览器和技术栈兼容。
- **验收标准**：
    - a. **浏览器**：支持最新版本的 Chrome, Firefox, Edge, Safari。
    - b. **Web 应用**：与任何使用标准 HTML 表单提交的 Web 应用兼容，不限制后端是 Java, Python, Node.js 或其他技术栈。

### 3.4. 可用性与可靠性
- **需求描述**：网关应具备高可用性，并在故障时提供预案。
- **验收标准**：
    - a. 提供一个 HTTP 健康检查端点（例如 `/healthz`），方便监控系统和负载均衡器进行状态检测。
    - b. 提供一个明确的旁路（bypass）或故障切换机制，在网关故障时，可以快速将流量切回后端服务直连。

### 3.5. 可配置性
- **需求描述**：核心参数应支持灵活配置。
- **验收标准**：
    - a. 支持通过配置文件（如 `config.yaml`）和环境变量进行配置，且环境变量的优先级高于配置文件。
    - b. 可配置项包括：监听端口、后端服务 URL、TLS 证书及私钥路径、主加密密钥、日志级别等。

### 3.6. 可扩展性
- **需求描述**：系统设计应具备良好的扩展性，以支持未来功能迭代。
- **验收标准**：
    - a. 核心处理流程（如请求拦截、解密、转发）应设计成模块化或中间件（Middleware）模式。
    - b. 预留插件接口，以便未来可以方便地集成 WAF、限流、日志审计等新功能。

---

## 4. 边界、约束与初始版本范围

### 4.1. 初始版本（v1.0）处理范围
- **请求方法**：仅处理 `POST` 方法的请求。
- **内容类型**：仅处理 `Content-Type` 为 `application/x-www-form-urlencoded` 和 `application/json` 的请求。

### 4.2. 初始版本（v1.0）暂不处理
- `GET` 请求或其他方法的请求参数加密。
- `multipart/form-data` 类型的文件上传表单。
- WebSocket 或其他非 HTTP 协议。
- 自动化的故障切换。
